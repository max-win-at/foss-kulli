<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta
      name="description"
      content="Foss Kulli - A simple sticky notes app for your browser"
    />
    <title>Foss Kulli - Sticky Notes</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6200ee" />
    <meta name="background-color" content="#e1f5fe" />
    <meta name="application-name" content="Foss Kulli" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Foss Kulli" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="msapplication-TileColor" content="#6200ee" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="format-detection" content="telephone=no" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- Favicon & Icons -->
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png" />
    <link rel="mask-icon" href="icons/icon.svg" color="#6200ee" />
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap"
      rel="stylesheet"
    />

    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/styles.css" />
  </head>

  <body x-data="vmDom" @resize.window="onResize()">
    <!-- Main White Board -->
    <div
      class="white-board"
      x-data="vmWhiteBoard"
      @keydown.window="onKeyDown($event)"
      @paste.window="onPaste($event)"
    >
      <!-- Hidden Input for Mobile Keyboard & Clipboard Support -->
      <input
        id="invisible-input"
        type="text"
        class="hidden-input"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
        @input="onInput($event)"
        @blur="onInputBlur($event)"
        aria-label="Type to create a new note"
      />

      <!-- Create Note Stack Button & Hint -->
      <!-- Removed x-show="hintVisible" from container so stack is always visible -->
      <div
        class="empty-state-container"
        @click="createNewNote()"
        title="Create new note"
      >
        <div class="note-stack">
          <div class="note-sheet back"></div>
          <div class="note-sheet top">
            <span class="material-icons note-plus-icon">add</span>
          </div>
        </div>
      </div>

      <!-- Hint Text (Bottom Center) -->
      <!-- Moved out of empty-state-container for independent positioning -->
      <div class="add-hint-text" x-show="hintVisible" x-transition.opacity>
        Start Typing, Paste From Clipboard or Press +
      </div>

      <!-- Sticky Notes Container -->
      <template x-for="note in notes" :key="note.id">
        <div
          class="sticky-note"
          :style="`left: ${note.x}px; top: ${note.y}px;`"
          x-show="matchesSearch(note)"
          @click.stop="editNote(note)"
        >
          <div class="note-date-header" x-text="note.formattedDate"></div>
          <div class="note-content" x-text="note.text"></div>
        </div>
      </template>

      <!-- Currently Editing Note (immediate spawn with cursor) -->
      <div
        class="sticky-note editing"
        :class="{ 'deleting': isDeleting }"
        x-show="editingNote"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-90"
        x-transition:enter-end="opacity-100 scale-100"
        :style="editingNote ? `left: ${editingNote.x}px; top: ${editingNote.y}px;` : ''"
      >
        <div
          contenteditable="true"
          class="note-editor"
          x-ref="noteEditor"
          @input="updateEditingText($event.target.textContent)"
          @keydown="onEditingKeyDown($event)"
          @blur="!isDeleting && confirmEditing()"
        ></div>
        <!-- Added !isDeleting check to blur so it doesn't auto-save while fading out if focus is lost -->
      </div>

      <!-- Selected Note Menu (FABs below the note) -->
      <div
        class="selected-note-menu"
        x-show="editingNote && !isDeleting"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-90"
        x-transition:enter-end="opacity-100 scale-100"
        :style="editingNote ? `left: ${editingNote.x}px; top: ${editingNote.y + 190}px;` : ''"
      >
        <!-- Delete Button -->
        <button
          class="fab action-fab btn-delete"
          @mousedown.prevent
          @click.stop="deleteEditingNote()"
          @mouseenter="onDeleteEnter()"
          @mouseleave="onDeleteLeave()"
        >
          <span
            class="material-icons"
            x-text="deleteIcon"
            :style="`opacity: ${iconOpacity}`"
            >delete</span
          >
        </button>

        <!-- Drag Button -->
        <button
          class="fab action-fab btn-drag"
          @mousedown.prevent
          @mousedown="onDragStart()"
          @mouseup="onDragEnd()"
          @mouseleave="onDragEnd()"
        >
          <span
            class="material-icons"
            x-text="dragIcon"
            :style="`opacity: ${iconOpacity}`"
            >pan_tool</span
          >
        </button>
      </div>

      <!-- Search FAB Button -->
      <button
        class="fab fab-search"
        @click.stop="toggleSearch()"
        aria-label="Search notes"
      >
        <span class="material-icons">search</span>
      </button>

      <!-- About FAB Button -->
      <button
        class="fab fab-about"
        @click.stop="toggleAbout()"
        aria-label="About"
      >
        <span class="material-icons">info</span>
      </button>

      <!-- Popup Backdrop (click to close) -->
      <div
        class="popup-backdrop"
        x-show="isSearchOpen || isAboutOpen"
        @click="closePopups()"
        x-transition.opacity
      ></div>

      <!-- Search Popup -->
      <div
        class="popup popup-search"
        x-show="isSearchOpen"
        @click.stop
        x-transition
      >
        <div class="search-input-wrapper">
          <input
            type="text"
            placeholder="Search notes..."
            x-model="searchQuery"
            @keydown.escape="closePopups()"
            x-ref="searchInput"
          />
          <button
            class="search-clear-btn"
            x-show="searchQuery.length > 0"
            @click="clearSearch()"
            aria-label="Clear search"
          >
            <span class="material-icons">close</span>
          </button>
        </div>
      </div>

      <!-- About Popup -->
      <div
        class="popup popup-about"
        x-show="isAboutOpen"
        @click.stop
        x-transition
      >
        <h3>Foss Kulli</h3>
        <p>
          A simple sticky notes app for your browser. Just start typing or paste
          from clipboard to create notes.
        </p>
        <p>Open source and privacy-focused. Your notes stay in your browser.</p>
        <div class="version">Version 0.1.0</div>
      </div>
    </div>

    <!-- Load app scripts first, then Alpine -->
    <script src="js/services/srv-local-storage.js"></script>
    <script src="js/viewmodels/vm-dom.js"></script>
    <script src="js/viewmodels/vm-sticky-note.js"></script>
    <script src="js/viewmodels/vm-white-board.js"></script>
    <script src="js/app.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- PWA Service Worker Registration -->
    <script src="js/pwa-register.js"></script>
  </body>
</html>
